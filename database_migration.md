Step 7: Database Migrations with Alembic
Why Use Alembic?
Instead of dropping/recreating your database every time you change models, Alembic tracks and applies incremental changes (migrations). This is essential for:

Production deployments (can't drop production data!)
Team collaboration (share schema changes)
Rolling back bad changes
Maintaining migration history

Important: Where Does Alembic Live?
Alembic is installed in your project repo. It's a Python package that connects to SQL Server (just like your FastAPI app does).
Your Setup:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI Project (WSL)  â”‚
â”‚  â”œâ”€â”€ main.py            â”‚
â”‚  â”œâ”€â”€ models.py          â”‚
â”‚  â”œâ”€â”€ database.py        â”‚
â”‚  â””â”€â”€ alembic/   â† HERE  â”‚ â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                              â”‚ Connects to
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  Docker Container       â”‚  â”‚
â”‚  â””â”€â”€ SQL Server         â”‚ â†â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Install Alembic
bash# In your FastAPI project directory
pip install OR uv add alembic
Initialize Alembic
bash# Creates alembic directory and alembic.ini
alembic init alembic
This creates:
your-project/
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ env.py           # Alembic configuration
â”‚   â”œâ”€â”€ script.py.mako   # Migration template
â”‚   â””â”€â”€ versions/        # Migration files go here
â”œâ”€â”€ alembic.ini          # Alembic settings
â”œâ”€â”€ main.py
â”œâ”€â”€ models.py
â””â”€â”€ database.py
Configure Alembic for SQL Server
Step 1: Edit alembic.ini
Find this line:
inisqlalchemy.url = driver://user:pass@localhost/dbname
Comment it out (we'll use env.py instead):
ini# sqlalchemy.url = driver://user:pass@localhost/dbname
Step 2: Edit alembic/env.py
Replace the file with this:
pythonfrom logging.config import fileConfig
from sqlalchemy import engine_from_config, pool
from alembic import context
import os
import sys

# Add your project directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(__file__)))

# Import your models and Base
from database import Base, SQLALCHEMY_DATABASE_URL
from models import Users, Todos  # Import ALL your models

# this is the Alembic Config object
config = context.config

# Set the database URL from your database.py
config.set_main_option('sqlalchemy.url', SQLALCHEMY_DATABASE_URL)

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Set target metadata for 'autogenerate' support
target_metadata = Base.metadata


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(
            connection=connection,
            target_metadata=target_metadata
        )

        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
Key changes:

Imports your Base and models
Uses SQLALCHEMY_DATABASE_URL from your database.py
Sets target_metadata = Base.metadata so Alembic can detect model changes

Create Your First Migration
Remove the manual table creation from main.py
Before:
python# main.py
from database import engine, Base

Base.metadata.create_all(bind=engine)  # â† Remove this line!
After:
python# main.py
from database import engine, Base

# Table creation is now handled by Alembic migrations
# Base.metadata.create_all(bind=engine)  # Removed
Generate initial migration
bash# Alembic will inspect your models and generate migration
alembic revision --autogenerate -m "Initial migration"
Output:
INFO  [alembic.runtime.migration] Context impl MSSQLImpl.
INFO  [alembic.autogenerate.compare] Detected added table 'users'
INFO  [alembic.autogenerate.compare] Detected added table 'todos'
  Generating /home/cryptox/project/alembic/versions/abc123_initial_migration.py
Review the migration
Check alembic/versions/abc123_initial_migration.py:
pythondef upgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.create_table('users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(length=100), nullable=True),
        sa.Column('username', sa.String(length=50), nullable=True),
        # ... more columns
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('email'),
        sa.UniqueConstraint('username')
    )
    # ... more tables


def downgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.drop_table('todos')
    op.drop_table('users')
Important: Always review auto-generated migrations!
Apply the migration
bash# Run the migration
alembic upgrade head
Output:
INFO  [alembic.runtime.migration] Running upgrade  -> abc123, Initial migration
Your tables are now created via migration! ðŸŽ‰
Common Alembic Workflows
1. Adding a New Column to Existing Model
models.py:
pythonclass Users(Base):
    __tablename__ = "users"
    # ... existing columns
    phone_number = Column(String(20), nullable=True)  # New column!
Create and apply migration:
bash# Generate migration
alembic revision --autogenerate -m "Add phone number to users"

# Review the generated file in alembic/versions/

# Apply migration
alembic upgrade head
2. Adding a New Table
models.py:
pythonclass Comments(Base):  # New model!
    __tablename__ = "comments"
    id = Column(Integer, primary_key=True, index=True)
    content = Column(String(500))
    todo_id = Column(Integer, ForeignKey("todos.id"))
Create and apply migration:
bashalembic revision --autogenerate -m "Add comments table"
alembic upgrade head
3. Modifying Column Type
Manual migration needed (autogenerate can't always detect this):
bash# Create empty migration
alembic revision -m "Change username to longer string"
Edit the generated file:
pythondef upgrade() -> None:
    op.alter_column('users', 'username',
               existing_type=sa.String(50),
               type_=sa.String(100),  # Change length
               existing_nullable=True)


def downgrade() -> None:
    op.alter_column('users', 'username',
               existing_type=sa.String(100),
               type_=sa.String(50),  # Revert
               existing_nullable=True)
Apply:
bashalembic upgrade head
Essential Alembic Commands
bash# Check current migration status
alembic current

# See migration history
alembic history --verbose

# Upgrade to latest
alembic upgrade head

# Upgrade one version at a time
alembic upgrade +1

# Downgrade one version
alembic downgrade -1

# Downgrade to specific revision
alembic downgrade abc123

# Downgrade all (back to empty database)
alembic downgrade base

# Generate new migration (auto-detect changes)
alembic revision --autogenerate -m "Description"

# Create empty migration (for manual edits)
alembic revision -m "Description"

# Show SQL without executing (dry run)
alembic upgrade head --sql
Migration Best Practices
1. Always Review Auto-Generated Migrations
Alembic can miss:

Column type changes
Column renames (it sees as drop + add)
Data migrations
Index changes

2. One Logical Change Per Migration
bash# Good
alembic revision --autogenerate -m "Add user email verification"

# Bad
alembic revision --autogenerate -m "Add email, fix todos, update comments"
3. Test Migrations Both Ways
bash# Test upgrade
alembic upgrade head

# Test downgrade
alembic downgrade -1

# Test upgrade again
alembic upgrade head
4. Add Migration Files to Git
bashgit add alembic/versions/*.py
git commit -m "Add migration: user email verification"
Don't gitignore: alembic/versions/
Do gitignore: __pycache__ in alembic directory
5. Data Migrations
For changing data (not just schema):
pythondef upgrade() -> None:
    # Schema change
    op.add_column('users', sa.Column('status', sa.String(20)))
    
    # Data migration
    op.execute("UPDATE users SET status = 'active' WHERE is_active = 1")
    op.execute("UPDATE users SET status = 'inactive' WHERE is_active = 0")
    
    # Remove old column
    op.drop_column('users', 'is_active')
Troubleshooting
"Target database is not up to date"
bash# Check current version
alembic current

# Stamp database to current code state (use carefully!)
alembic stamp head
"Table already exists"
Your database has tables but no Alembic history:
bash# Mark current state as migrated (without running migrations)
alembic stamp head
Start Fresh (Development Only)
bash# Drop all tables
sqlcmd -S localhost -U sa -P DevPassword123 -C -Q "DROP DATABASE DevDB; CREATE DATABASE DevDB;"

# Remove all migrations
rm alembic/versions/*.py

# Generate fresh initial migration
alembic revision --autogenerate -m "Initial migration"

# Apply it
alembic upgrade head
Working with Team
When pulling new migrations from Git:
bash# Pull latest code (includes new migrations)
git pull

# Check what migrations need to run
alembic current
alembic history

# Apply new migrations
alembic upgrade head
When your migration conflicts with teammate's:
bash# Check history
alembic history

# May need to merge migration branches
alembic merge heads -m "Merge migrations"

# Then upgrade
alembic upgrade head

Summary
Development Setup:
bash# 1. Install Docker
sudo apt install -y docker.io && sudo service docker start

# 2. Run SQL Server
docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=DevPassword123!" \
  -p 1433:1433 --name sqlserver -v sqlvolume:/var/opt/mssql \
  -d mcr.microsoft.com/mssql/server:2022-latest

# 3. Install Python packages
pip install sqlalchemy pymssql fastapi uvicorn alembic

# 4. Update connection string
DATABASE_URL = "mssql+pymssql://sa:DevPassword123!@localhost/DevDB"

# 5. Initialize Alembic
alembic init alembic
# (Configure alembic/env.py as shown above)

# 6. Create and apply migrations
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
Daily Usage:

Start: docker start sqlserver
Stop: docker stop sqlserver
Connect: VS Code extension or sqlcmd
Migrate: alembic upgrade head


Key Alembic Commands:

Create migration: alembic revision --autogenerate -m "message"
Apply migrations: alembic upgrade head
Rollback: alembic downgrade -1
Check status: alembic current
